---
interface Props {
  lang: string;
}

const { lang } = Astro.props;
---

<sy-calendar-modal>
  <div class="modal-overlay" data-calendar-overlay>
    <div class="modal-content has-calendar">
      <button class="modal-close" data-calendar-close aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <div class="cal-container">
        <h2 class="u-heading form-title" data-lang-key="form.calendar.title">Записаться на встречу</h2>
        <p class="u-text form-subtitle" data-lang-key="form.calendar.subtitle">Выберите удобное время</p>
        <div class="cal-wrapper">
          <div id="cal-com-embed" data-cal-username="dayanch-kakamyradov-vm0qss"></div>
          <iframe 
            id="cal-iframe-fallback"
            src="https://app.cal.com/dayanch-kakamyradov-vm0qss" 
            class="cal-iframe"
            frameborder="0"
            allow="camera; microphone; geolocation"
            loading="eager"
          ></iframe>
        </div>
      </div>
    </div>
  </div>
</sy-calendar-modal>

<script>
  import { useTranslations } from "../i18n/utils";
  
  const lang = (document.documentElement.lang || "ru") as keyof typeof import("../i18n/ui").languages;
  const t = useTranslations(lang);
  
  const translations: Record<string, Record<string, string>> = {
    ru: {
      "form.calendar.title": "Записаться на встречу",
      "form.calendar.subtitle": "Выберите удобное время",
    },
    tk: {
      "form.calendar.title": "Duşuşmaga ýazylmak",
      "form.calendar.subtitle": "Amatly wagty saýlaň",
    },
    en: {
      "form.calendar.title": "Book a meeting",
      "form.calendar.subtitle": "Choose a convenient time",
    },
  };
  
  function updateCalendarTexts() {
    const currentLang = (document.documentElement.lang || "ru") as keyof typeof translations;
    const t = translations[currentLang] || translations.ru;
    
    document.querySelectorAll("[data-lang-key]").forEach((el) => {
      const key = el.getAttribute("data-lang-key");
      if (key && t[key]) {
        el.textContent = t[key];
      }
    });
  }
  
  let scrollPosition = 0;
  let wheelHandler: ((e: WheelEvent) => void) | null = null;
  let touchHandler: ((e: TouchEvent) => void) | null = null;
  let scrollHandler: ((e: Event) => void) | null = null;
  let modalWheelHandler: ((e: WheelEvent) => void) | null = null;
  let currentOverlay: HTMLElement | null = null;
  let currentModalContent: HTMLElement | null = null;

  // Инициализация Cal.com iframe
  function initCalEmbed() {
    const fallbackIframe = document.getElementById("cal-iframe-fallback") as HTMLIFrameElement;
    const calContainer = document.getElementById("cal-com-embed");
    
    if (!fallbackIframe) {
      console.error("Cal.com iframe not found!");
      return;
    }
    
    const calUsername = calContainer?.getAttribute("data-cal-username") || "dayanch-kakamyradov-vm0qss";
    const iframeUrl = `https://app.cal.com/${calUsername}`;
    
    // Устанавливаем src iframe
    if (fallbackIframe.src !== iframeUrl) {
      fallbackIframe.src = iframeUrl;
    }
    
    // Принудительно показываем iframe
    fallbackIframe.style.display = "block";
    fallbackIframe.style.visibility = "visible";
    fallbackIframe.style.opacity = "1";
    fallbackIframe.style.width = "100%";
    fallbackIframe.style.height = "500px";
    fallbackIframe.style.position = "relative";
    fallbackIframe.style.zIndex = "10";
    fallbackIframe.style.border = "none";
    fallbackIframe.style.borderRadius = "0.75rem";
    fallbackIframe.style.background = "white";
    
    console.log("Cal.com iframe initialized:", {
      src: fallbackIframe.src,
      display: fallbackIframe.style.display,
      visibility: fallbackIframe.style.visibility,
      opacity: fallbackIframe.style.opacity,
      width: fallbackIframe.offsetWidth,
      height: fallbackIframe.offsetHeight,
      computedDisplay: window.getComputedStyle(fallbackIframe).display
    });
  }

  function openCalendar() {
    const overlay = document.querySelector<HTMLElement>("[data-calendar-overlay]");
    const modalContent = document.querySelector<HTMLElement>(".modal-content.has-calendar");
    if (overlay && modalContent) {
      currentOverlay = overlay;
      currentModalContent = modalContent;
      scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      
      // На мобильных устройствах сразу показываем модальное окно без анимации
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        overlay.style.opacity = "1";
        overlay.style.pointerEvents = "all";
        modalContent.style.opacity = "1";
        modalContent.style.transform = "scale(1) translateY(0)";
      }
      
      overlay.classList.add("active");
      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollPosition}px`;
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
      document.documentElement.style.overflow = "hidden";

      wheelHandler = (e: WheelEvent) => {
        const path = e.composedPath();
        const isInsideModalContent = path.some((node) => {
          const el = node as HTMLElement;
          return el === modalContent || (el.nodeType === 1 && modalContent.contains(el));
        });
        if (isInsideModalContent) {
          return;
        }
        e.preventDefault();
        e.stopPropagation();
      };

      touchHandler = (e: TouchEvent) => {
        const path = e.composedPath();
        const isInsideModalContent = path.some((node) => {
          const el = node as HTMLElement;
          return el === modalContent || (el.nodeType === 1 && modalContent.contains(el));
        });
        if (isInsideModalContent) {
          return;
        }
        // Блокируем только touchmove (скролл), не touchstart (клики)
        if (e.type === 'touchmove') {
          e.preventDefault();
          e.stopPropagation();
        }
      };

      scrollHandler = (e: Event) => {
        const target = e.target as HTMLElement;
        const path = e.composedPath();
        const isInsideModalContent = path.some((node) => {
          const el = node as HTMLElement;
          return el === modalContent || (el.nodeType === 1 && modalContent.contains(el));
        });

        if (isInsideModalContent || target === overlay) {
          return;
        }
        e.preventDefault();
        window.scrollTo(0, scrollPosition);
      };

      modalWheelHandler = (e: WheelEvent) => {
        e.stopPropagation();
      };
      modalContent.addEventListener("wheel", modalWheelHandler, { passive: true, capture: true });

      overlay.addEventListener("wheel", wheelHandler, { passive: false });
      overlay.addEventListener("touchmove", touchHandler, { passive: false });
      overlay.addEventListener("touchstart", touchHandler, { passive: true });
      window.addEventListener("scroll", scrollHandler, { passive: false });

      updateCalendarTexts();
      
      // Прокручиваем модальное окно вверх
      requestAnimationFrame(() => {
        modalContent.scrollTop = 0;
      });
      
      // Инициализируем Cal.com iframe сразу
      setTimeout(() => {
        initCalEmbed();
        // Дополнительно убеждаемся что iframe виден после инициализации
        requestAnimationFrame(() => {
          const iframe = document.getElementById("cal-iframe-fallback") as HTMLIFrameElement;
          if (iframe) {
            iframe.style.display = "block";
            iframe.style.visibility = "visible";
            iframe.style.opacity = "1";
            console.log("Iframe forced visible after init");
          }
        });
      }, 50);
    }
  }

  function closeCalendar() {
    const overlay = currentOverlay || document.querySelector<HTMLElement>("[data-calendar-overlay]");
    if (overlay) {
      overlay.classList.remove("active");
      if (wheelHandler && overlay) {
        overlay.removeEventListener("wheel", wheelHandler);
        wheelHandler = null;
      }
      if (touchHandler && overlay) {
        overlay.removeEventListener("touchmove", touchHandler);
        touchHandler = null;
      }
      if (scrollHandler) {
        window.removeEventListener("scroll", scrollHandler);
        scrollHandler = null;
      }
      if (modalWheelHandler && currentModalContent) {
        currentModalContent.removeEventListener("wheel", modalWheelHandler, { capture: true } as any);
        modalWheelHandler = null;
        currentModalContent = null;
      }
      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.width = "";
      document.body.style.overflow = "";
      document.documentElement.style.overflow = "";
      window.scrollTo(0, scrollPosition);
      scrollPosition = 0;
      currentOverlay = null;
    }
  }

  // Обработчики событий
  // Используем capture для мобильных устройств, чтобы события обрабатывались раньше
  const clickHandler = (e: MouseEvent | TouchEvent) => {
    const target = (e.target as HTMLElement) || ((e as TouchEvent).touches?.[0]?.target as HTMLElement);
    if (!target) return;
    
    // Открытие календаря
    if (target.closest("[data-open-calendar]")) {
      e.preventDefault();
      e.stopPropagation();
      // Небольшая задержка для мобильных, чтобы убедиться что событие обработано
      if (window.innerWidth <= 768) {
        setTimeout(() => openCalendar(), 10);
      } else {
        openCalendar();
      }
      return;
    }
    
    // Закрытие календаря
    if (target.closest("[data-calendar-close]") || (target.closest("[data-calendar-overlay]") && target === target.closest("[data-calendar-overlay]"))) {
      e.preventDefault();
      e.stopPropagation();
      closeCalendar();
    }
  };
  
  document.addEventListener("click", clickHandler, { capture: true });
  document.addEventListener("touchend", clickHandler, { capture: true });

  // Экспортируем функции для глобального доступа
  (window as any).openCalendar = openCalendar;
  (window as any).closeCalendar = closeCalendar;

  // Update texts when language changes
  document.addEventListener("langchange", updateCalendarTexts);
  updateCalendarTexts();
</script>

<style>
  sy-calendar-modal {
    display: block;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    height: 100dvh; /* Для мобильных устройств */
    background: rgba(var(--rgb-brand-1), 0.4);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-out-cubic);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .modal-overlay.active {
    opacity: 1;
    pointer-events: all;
  }

  .modal-content {
    background: rgba(var(--rgb-brand-3), 0.95);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(var(--rgb-brand-1), 0.3);
    border-radius: 1.5rem;
    padding: 1rem 1.5rem;
    max-width: 26rem;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    overflow-x: hidden;
    box-shadow: 0 20px 60px rgba(var(--rgb-brand-1), 0.2), 0 0 0 1px rgba(var(--rgb-brand-1), 0.1);
    transform: scale(0.95) translateY(1rem);
    transition: transform 0.3s var(--ease-out-cubic), opacity 0.3s var(--ease-out-cubic), max-width 0.3s var(--ease-out-cubic);
    opacity: 0;
  }
  
  .modal-content.has-calendar {
    max-width: 42rem;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    padding-top: 0.5rem;
    padding-bottom: 1rem;
  }

  .modal-overlay.active .modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
  
  /* Отключаем все анимации на мобильных устройствах */
  @media (max-width: 768px) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      transition-delay: 0ms !important;
      scroll-behavior: auto !important;
    }
    
    .modal-overlay {
      transition: opacity 0.01ms !important;
    }
    
    .modal-content {
      transform: scale(1) translateY(0) !important;
      transition: none !important;
      opacity: 1 !important;
    }
    
    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0) !important;
    }
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 2.5rem;
    height: 2.5rem;
    min-width: 2.5rem;
    min-height: 2.5rem;
    border: none;
    background: rgba(var(--rgb-brand-1), 0.8);
    backdrop-filter: blur(10px);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    color: white;
    z-index: 1001;
    transition: all 0.2s var(--ease-out-cubic);
    touch-action: manipulation; /* Улучшает отзывчивость на мобильных */
  }

  .modal-close:hover {
    background: var(--color-brand-1);
    transform: scale(1.1);
  }

  /* Кастомный скроллбар */
  .modal-content::-webkit-scrollbar {
    width: 8px;
  }

  .modal-content::-webkit-scrollbar-track {
    background: rgba(var(--rgb-brand-3), 0.3);
    border-radius: 4px;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: rgba(var(--rgb-brand-1), 0.5);
    border-radius: 4px;
  }

  .modal-content::-webkit-scrollbar-thumb:hover {
    background: rgba(var(--rgb-brand-1), 0.7);
  }

  /* Стили для Cal.com контейнера */
  .cal-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-top: 0;
    margin-top: 0;
  }
  
  .cal-container .form-title {
    margin-bottom: 0;
    margin-top: 0;
    font-size: 1.1rem;
    line-height: 1.2;
    padding-top: 0;
  }
  
  .cal-container .form-subtitle {
    margin-bottom: 0.25rem;
    margin-top: 0;
    font-size: 0.8rem;
    line-height: 1.2;
    padding-top: 0;
  }
  
  .cal-wrapper {
    position: relative;
    width: 100%;
    min-height: 500px;
    max-height: 500px;
    margin-top: 0.5rem;
    margin-bottom: 0;
    display: block;
    overflow: visible;
    /* Убеждаемся что контейнер виден */
    visibility: visible;
    opacity: 1;
  }
  
  #cal-com-embed {
    width: 100%;
    min-height: 500px;
    max-height: 500px;
    display: none;
  }
  
  /* Стили для Cal.com iframe */
  .cal-iframe {
    width: 100% !important;
    height: 500px !important;
    min-height: 500px !important;
    max-height: 500px !important;
    border: none !important;
    border-radius: 0.75rem;
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    flex-shrink: 0;
    position: relative !important;
    z-index: 10 !important;
    background: white !important;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    /* Принудительно показываем iframe */
    pointer-events: auto !important;
    /* Убеждаемся что iframe не скрыт */
    clip: auto !important;
    clip-path: none !important;
  }

  @media (max-width: 640px) {
    .modal-overlay {
      padding: 0.5rem;
      align-items: flex-start;
      padding-top: 1rem;
    }
    
    .modal-content {
      max-width: calc(100% - 1rem);
      width: calc(100% - 1rem);
      padding: 1rem;
      max-height: calc(100vh - 2rem);
      max-height: calc(100dvh - 2rem);
      margin: 0 auto;
      border-radius: 1rem;
    }
    
    .modal-content.has-calendar {
      max-width: calc(100% - 1rem);
      width: calc(100% - 1rem);
      padding-top: 0.5rem;
      padding-bottom: 1rem;
    }
    
    .modal-close {
      top: 0.75rem;
      right: 0.75rem;
      width: 2rem;
      height: 2rem;
      min-width: 2rem;
      min-height: 2rem;
    }

    .cal-container {
      gap: 0.5rem;
    }
    
    .cal-container .form-title {
      font-size: 1rem;
    }
    
    .cal-container .form-subtitle {
      font-size: 0.75rem;
    }
    
    .cal-wrapper {
      min-height: 400px;
      max-height: 400px;
      margin-top: 0.1rem;
    }
    
    #cal-com-embed {
      min-height: 400px;
      max-height: 400px;
    }
    
    .cal-iframe {
      height: 400px !important;
      min-height: 400px !important;
      max-height: 400px !important;
    }
  }
  
  @media (max-width: 480px) {
    .modal-overlay {
      padding: 0.25rem;
      padding-top: 0.5rem;
    }
    
    .modal-content {
      max-width: calc(100% - 0.5rem);
      width: calc(100% - 0.5rem);
      padding: 0.875rem;
      max-height: calc(100vh - 1rem);
      max-height: calc(100dvh - 1rem);
      border-radius: 0.75rem;
    }
    
    .modal-content.has-calendar {
      max-width: calc(100% - 0.5rem);
      width: calc(100% - 0.5rem);
    }
    
    .modal-close {
      top: 0.5rem;
      right: 0.5rem;
      width: 1.75rem;
      height: 1.75rem;
      min-width: 1.75rem;
      min-height: 1.75rem;
    }
    
    .cal-wrapper {
      min-height: 350px;
      max-height: 350px;
    }
    
    #cal-com-embed {
      min-height: 350px;
      max-height: 350px;
    }
    
    .cal-iframe {
      height: 350px !important;
      min-height: 350px !important;
      max-height: 350px !important;
    }
  }
</style>
