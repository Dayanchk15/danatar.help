<script>
  declare global {
    interface Window {
      scrollVelocity: number;
      scrollDirection: number;
      scrollCurrent: number;
      scrollStickyOffsets: [number, number, number][];
    }
  }

  import Lenis from "lenis";
  import ScrollTrigger from "gsap/ScrollTrigger";
  import { addGlobalTicker } from "../utils/globalTicker";

  window.scrollStickyOffsets = window.scrollStickyOffsets || [];
  window.scrollVelocity = 0;
  window.scrollDirection = 1;

  // Определяем производительность устройства
  const isLowEndDevice = 
    (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4) ||
    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
    window.innerWidth < 1024;
  
  // Полностью отключаем smooth scroll на слабых устройствах для максимальной производительности
  if (isLowEndDevice) {
    // Просто используем обычный скролл без Lenis
    window.scrollVelocity = 0;
    window.scrollDirection = 1;
    window.scrollCurrent = 0;
    
    // Обновляем scrollCurrent при скролле
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', () => {
      const currentScrollY = window.scrollY;
      window.scrollCurrent = currentScrollY;
      window.scrollVelocity = Math.abs(currentScrollY - lastScrollY);
      window.scrollDirection = currentScrollY > lastScrollY ? 1 : -1;
      lastScrollY = currentScrollY;
    }, { passive: true });
    
    // Простой ScrollTrigger update без Lenis
    let scrollUpdateTimeout: number | null = null;
    let lastUpdateTime = 0;
    const updateInterval = 150; // Еще реже обновляем
    
    window.addEventListener('scroll', () => {
      const now = performance.now();
      if (now - lastUpdateTime < updateInterval) return;
      
      if (scrollUpdateTimeout) return;
      scrollUpdateTimeout = requestAnimationFrame(() => {
        ScrollTrigger.update();
        lastUpdateTime = performance.now();
        scrollUpdateTimeout = null;
      });
    }, { passive: true });
  } else {
    // Оптимизированные настройки для обычных устройств
    const lenis = new Lenis({
      syncTouch: true,
      lerp: 0.1,
      duration: 0.8,
      easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      smoothWheel: true,
      smoothTouch: false,
      touchMultiplier: 2,
    });
    
    // Throttle ScrollTrigger update для производительности - более агрессивный throttling
    let scrollUpdateTimeout: number | null = null;
    let lastUpdateTime = 0;
    const updateInterval = 50;
    
    lenis.on("scroll", () => {
      const now = performance.now();
      if (now - lastUpdateTime < updateInterval) return;
      
      if (scrollUpdateTimeout) return;
      scrollUpdateTimeout = requestAnimationFrame(() => {
        ScrollTrigger.update();
        lastUpdateTime = performance.now();
        scrollUpdateTimeout = null;
      });
    });
    
    lenis.direction = 1;
    
    // Пауза анимации при неактивной вкладке
    let isTabVisible = !document.hidden;
    document.addEventListener("visibilitychange", () => {
      isTabVisible = !document.hidden;
      if (!isTabVisible) {
        lenis.stop();
      } else {
        lenis.start();
      }
    });
    
    addGlobalTicker((t: number) => {
      if (isTabVisible) {
        lenis.raf(t * 1000);
        window.scrollVelocity = lenis.velocity;
        window.scrollDirection = lenis.direction;
        window.scrollCurrent = lenis.animatedScroll;
      }
    });
    
    // Handle anchor links with smooth scroll
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const link = target.closest("a");
      
      if (!link) return;
      
      const href = link.getAttribute("href");
      if (!href || !href.startsWith("#")) return;
      
      // Skip if it's a language switch link
      if (link.hasAttribute("data-lang-switch")) return;
      
      // Skip mailto and external links
      if (href.startsWith("mailto:") || href.startsWith("http")) return;
      
      const targetId = href.slice(1); // Remove #
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        e.preventDefault();
        lenis.scrollTo(targetElement, {
          offset: -80, // Offset for header
          duration: 1.5,
          easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        });
      }
    });
  }
  
  // Throttle ScrollTrigger update для производительности - более агрессивный throttling
  let scrollUpdateTimeout: number | null = null;
  let lastUpdateTime = 0;
  const updateInterval = isLowEndDevice ? 100 : 50; // Обновляем реже на слабых устройствах
  
  lenis.on("scroll", () => {
    const now = performance.now();
    if (now - lastUpdateTime < updateInterval) return;
    
    if (scrollUpdateTimeout) return;
    scrollUpdateTimeout = requestAnimationFrame(() => {
      ScrollTrigger.update();
      lastUpdateTime = performance.now();
      scrollUpdateTimeout = null;
    });
  });

  lenis.direction = 1;

  // Пауза анимации при неактивной вкладке
  let isTabVisible = !document.hidden;
  document.addEventListener("visibilitychange", () => {
    isTabVisible = !document.hidden;
    if (!isTabVisible) {
      lenis.stop();
    } else {
      lenis.start();
    }
  });

  addGlobalTicker((t: number) => {
    if (isTabVisible) {
      lenis.raf(t * 1000);
      window.scrollVelocity = lenis.velocity;
      window.scrollDirection = lenis.direction;
      window.scrollCurrent = lenis.animatedScroll;
    }
  });

  // Handle anchor links with smooth scroll
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const link = target.closest("a");
    
    if (!link) return;
    
    const href = link.getAttribute("href");
    if (!href || !href.startsWith("#")) return;
    
    // Skip if it's a language switch link
    if (link.hasAttribute("data-lang-switch")) return;
    
    // Skip mailto and external links
    if (href.startsWith("mailto:") || href.startsWith("http")) return;
    
    const targetId = href.slice(1); // Remove #
    const targetElement = document.getElementById(targetId);
    
    if (targetElement) {
      e.preventDefault();
      lenis.scrollTo(targetElement, {
        offset: -80, // Offset for header
        duration: 1.5,
        easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      });
    }
  });
</script>

<style>
  html.lenis,
  html.lenis body {
    height: auto;
  }

  .lenis:not(.lenis-autoToggle).lenis-stopped {
    overflow: clip;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-smooth iframe {
    pointer-events: none;
  }

  .lenis.lenis-autoToggle {
    transition-property: overflow;
    transition-duration: 1ms;
    transition-behavior: allow-discrete;
  }
</style>
