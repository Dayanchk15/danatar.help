<script>
  declare global {
    interface Window {
      scrollVelocity: number;
      scrollDirection: number;
      scrollCurrent: number;
      scrollStickyOffsets: [number, number, number][];
    }
  }

  import Lenis from "lenis";
  import ScrollTrigger from "gsap/ScrollTrigger";
  import { addGlobalTicker } from "../utils/globalTicker";

  window.scrollStickyOffsets = window.scrollStickyOffsets || [];
  window.scrollVelocity = 0;
  window.scrollDirection = 1;

  const lenis = new Lenis({
    syncTouch: true,
    lerp: 0.125,
  });
  lenis.on("scroll", ScrollTrigger.update);

  lenis.direction = 1;

  addGlobalTicker((t: number) => {
    lenis.raf(t * 1000);
    window.scrollVelocity = lenis.velocity;
    window.scrollDirection = lenis.direction;
    window.scrollCurrent = lenis.animatedScroll;
  });

  // Handle anchor links with smooth scroll
  document.addEventListener("click", (e) => {
    const target = e.target as HTMLElement;
    const link = target.closest("a");
    
    if (!link) return;
    
    const href = link.getAttribute("href");
    if (!href || !href.startsWith("#")) return;
    
    // Skip if it's a language switch link
    if (link.hasAttribute("data-lang-switch")) return;
    
    // Skip mailto and external links
    if (href.startsWith("mailto:") || href.startsWith("http")) return;
    
    const targetId = href.slice(1); // Remove #
    const targetElement = document.getElementById(targetId);
    
    if (targetElement) {
      e.preventDefault();
      lenis.scrollTo(targetElement, {
        offset: -80, // Offset for header
        duration: 1.5,
        easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      });
    }
  });
</script>

<style>
  html.lenis,
  html.lenis body {
    height: auto;
  }

  .lenis:not(.lenis-autoToggle).lenis-stopped {
    overflow: clip;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-smooth iframe {
    pointer-events: none;
  }

  .lenis.lenis-autoToggle {
    transition-property: overflow;
    transition-duration: 1ms;
    transition-behavior: allow-discrete;
  }
</style>
